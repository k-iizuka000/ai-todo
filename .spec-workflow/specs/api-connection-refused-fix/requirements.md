# Requirements Specification: API接続拒否エラー修正

## 1. Overview
**Feature Name**: api-connection-refused-fix  
**Priority**: 高（クリティカル）  
**Category**: バグ修正  
**Impact**: アプリケーション全体のタスク作成機能  

## 2. Problem Statement
### Current State
- 「全てのタスク」画面で新しいタスクを追加すると、`POST http://localhost:3003/api/v1/tasks net::ERR_CONNECTION_REFUSED`エラーが発生
- タスクはモックモードでフロントエンドにのみ保存され、ページリロード時に消失
- バックエンドAPIサーバー（ポート3003）が起動していない、または接続できない状態

### Desired State
- タスク追加時にバックエンドAPIと正常に通信できる
- タスクがデータベースに永続化される
- ページリロード後もタスクが保持される
- エラー発生時の適切なフォールバック処理

## 3. User Stories

### US-001: ユーザーとしてタスクを確実に追加したい
**As a** ユーザー  
**I want** タスクを追加した時に確実に保存される  
**So that** 作業内容が失われることなく管理できる  

**Acceptance Criteria:**
- タスクフォームからタスクを追加できる
- 追加したタスクがAPIを通じてデータベースに保存される
- ページをリロードしてもタスクが表示される
- API接続エラー時に適切なエラーメッセージが表示される

### US-002: 開発者としてバックエンドサービスの状態を監視したい
**As a** 開発者  
**I want** バックエンドAPIの接続状態を確認できる  
**So that** 問題を早期に検知し対処できる  

**Acceptance Criteria:**
- バックエンドAPIの起動状態を確認できる
- ヘルスチェックエンドポイントが機能する
- 接続失敗時のログが適切に記録される

## 4. Functional Requirements

### FR-001: バックエンドAPI起動確認
- Docker Composeでバックエンドサービスを起動する
- ポート3003でAPIサーバーが動作する
- ヘルスチェックエンドポイント（/health）が応答する

### FR-002: API接続リトライ機構
- 初回接続失敗時に最大3回までリトライする
- リトライ間隔を段階的に増やす（1秒、2秒、4秒）
- リトライ中は適切な状態表示を行う

### FR-003: エラーハンドリング改善
- 接続エラー時に明確なエラーメッセージを表示
- モックモードへの切り替えをユーザーに通知
- 接続回復時の自動同期機能

### FR-004: データ永続化確認
- タスク作成APIが正常に動作する
- データベースへの書き込みが成功する
- 作成されたタスクのIDが返される

## 5. Non-Functional Requirements

### NFR-001: パフォーマンス
- API応答時間: 200ms以内（95パーセンタイル）
- リトライ処理が他の操作をブロックしない

### NFR-002: 信頼性
- API接続失敗時でも基本機能は動作継続
- データ不整合を防ぐ楽観的ロック機構

### NFR-003: 運用性
- Dockerコンテナの自動ヘルスチェック
- ログによる問題診断の容易化

## 6. Constraints
- Docker環境での動作が必須
- 既存のアーキテクチャ（React + TypeScript + Express）を維持
- データベースはPostgreSQLを使用

## 7. Dependencies
- Docker Compose設定の修正
- バックエンドサービスの起動設定
- フロントエンドのエラーハンドリング改善

## 8. Success Metrics
- タスク作成成功率: 99.9%以上
- API接続エラー発生率: 0.1%以下
- ページリロード後のデータ保持率: 100%