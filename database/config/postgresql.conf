# PostgreSQL 15 Configuration for AI TODO Application (改良版)
# 設計書グループ1: Docker環境構成
# Version: 2.0 (改良版)
# Date: 2025-08-28

# ==================================================
# メモリ設定（改良版：パフォーマンス最適化）
# ==================================================

# 共有バッファ（改良版：SSD環境に最適化）
shared_buffers = 256MB                    # メモリの25%程度
effective_cache_size = 1GB                # システム全体のキャッシュサイズ見積もり
maintenance_work_mem = 64MB               # VACUUMやINDEX作成用
work_mem = 4MB                           # ソート、ハッシュテーブル用

# その他のメモリ設定
temp_buffers = 8MB                       # 一時バッファ
max_stack_depth = 2MB                    # スタック深度制限

# ==================================================
# 接続設定（改良版：開発環境最適化）
# ==================================================

max_connections = 100                    # 最大接続数
superuser_reserved_connections = 3       # スーパーユーザー予約接続数

# 接続プール設定
tcp_keepalives_idle = 600                # TCPキープアライブ（秒）
tcp_keepalives_interval = 30             # キープアライブ間隔
tcp_keepalives_count = 3                 # キープアライブ再送回数

# ==================================================
# WAL（Write-Ahead Logging）設定（改良版）
# ==================================================

wal_level = replica                      # レプリケーション対応レベル
wal_buffers = 16MB                       # WALバッファサイズ
max_wal_size = 1GB                       # WAL最大サイズ
min_wal_size = 80MB                      # WAL最小サイズ
checkpoint_timeout = 10min               # チェックポイント間隔
checkpoint_completion_target = 0.9       # チェックポイント完了目標

# WALアーカイブ設定（改良版：バックアップ対応）
archive_mode = on                        # アーカイブモード有効
archive_command = 'cp %p /backup/wal_archive/%f'  # アーカイブコマンド
archive_timeout = 300                    # アーカイブタイムアウト（秒）

# ==================================================
# パフォーマンス設定（改良版：SSD最適化）
# ==================================================

# ディスク設定（SSD環境）
random_page_cost = 1.1                   # SSD用の低いランダムコスト
effective_io_concurrency = 200           # SSD並列IO能力
seq_page_cost = 1.0                      # シーケンシャル読み取りコスト

# プランナー設定
cpu_tuple_cost = 0.01                    # CPU処理コスト
cpu_index_tuple_cost = 0.005             # インデックスCPUコスト
cpu_operator_cost = 0.0025               # 演算子CPUコスト

# 統計情報設定
default_statistics_target = 100          # 統計サンプル数
constraint_exclusion = partition         # パーティション最適化

# ==================================================
# ログ設定（改良版：デバッグ・監視最適化）
# ==================================================

# ログレベル設定
log_min_messages = info                  # 最小ログレベル
log_min_error_statement = error          # エラー文のログレベル
log_min_duration_statement = 1000       # 1秒以上のクエリをログ

# ログフォーマット（改良版：構造化ログ）
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_statement = 'all'                    # 全SQLステートメントをログ
log_duration = on                        # 実行時間をログ
log_lock_waits = on                      # ロック待機をログ
log_temp_files = 10MB                    # 一時ファイル使用をログ

# ログローテーション
log_destination = 'stderr'               # ログ出力先
logging_collector = on                   # ログコレクター有効
log_directory = '/var/log/postgresql'    # ログディレクトリ
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'  # ログファイル名
log_rotation_age = 1d                    # ログローテーション（1日）
log_rotation_size = 10MB                 # ログローテーション（サイズ）

# ==================================================
# 拡張機能設定（改良版）
# ==================================================

# 事前ロードライブラリ（改良版：統計収集）
shared_preload_libraries = 'pg_stat_statements,auth_delay'

# pg_stat_statements設定（改良版：クエリ監視）
pg_stat_statements.max = 10000           # 保持するクエリ統計数
pg_stat_statements.track = all           # 全クエリを追跡
pg_stat_statements.save = on             # 再起動時に統計保持
pg_stat_statements.track_utility = off   # ユーティリティコマンド除外

# ==================================================
# セキュリティ設定（改良版）
# ==================================================

# SSL設定（開発環境では無効、本番では有効にする）
ssl = off                                # SSL無効（開発環境）
# ssl_cert_file = 'server.crt'           # SSL証明書
# ssl_key_file = 'server.key'            # SSL秘密鍵

# 認証設定
password_encryption = scram-sha-256      # パスワード暗号化方式
db_user_namespace = off                  # ユーザー名前空間無効

# 接続制限
listen_addresses = '*'                   # 接続許可アドレス（開発環境）
port = 5432                              # ポート番号

# ==================================================
# その他の設定（改良版）
# ==================================================

# タイムゾーン
timezone = 'Asia/Tokyo'                  # タイムゾーン設定
log_timezone = 'Asia/Tokyo'              # ログタイムゾーン

# 言語・エンコーディング
lc_messages = 'en_US.utf8'               # メッセージ言語
lc_monetary = 'ja_JP.utf8'               # 通貨フォーマット
lc_numeric = 'ja_JP.utf8'                # 数値フォーマット
lc_time = 'ja_JP.utf8'                   # 時刻フォーマット

# 自動VACUUM設定（改良版：パフォーマンス重視）
autovacuum = on                          # 自動VACUUM有効
autovacuum_max_workers = 3               # 自動VACUUMワーカー数
autovacuum_naptime = 1min                # 自動VACUUM実行間隔
autovacuum_vacuum_threshold = 50         # VACUUM閾値
autovacuum_vacuum_scale_factor = 0.1     # VACUUMスケールファクター
autovacuum_analyze_threshold = 50        # ANALYZE閾値
autovacuum_analyze_scale_factor = 0.05   # ANALYZEスケールファクター

# バックグラウンドライター設定
bgwriter_delay = 200ms                   # バックグラウンドライター間隔
bgwriter_lru_maxpages = 100              # LRU最大ページ数
bgwriter_lru_multiplier = 2.0            # LRU倍率

# ==================================================
# 開発環境専用設定
# ==================================================

# デバッグ設定（本番環境では無効にする）
log_parser_stats = off                   # パーサー統計
log_planner_stats = off                  # プランナー統計
log_executor_stats = off                 # エグゼキューター統計
log_statement_stats = off                # ステートメント統計

# JIT設定（小規模開発では無効）
jit = off                                # JITコンパイル無効

# ==================================================
# コメント
# ==================================================

# 設定変更時は以下のコマンドでリロード：
# SELECT pg_reload_conf();
# 
# 設定確認コマンド：
# SHOW shared_buffers;
# SHOW effective_cache_size;
#
# パフォーマンス監視クエリ：
# SELECT * FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;